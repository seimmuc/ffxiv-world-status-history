{% macro timezone_head() %}
  <link rel="stylesheet" href="{{ static('timezones.css') }}">
  <script src="{{ static('timezones.js') }}"></script>
{% endmacro %}

{% macro timezones_form(csrf_input, tz_list, current_tz, return_url) %}
{% set current_tz = current_tz|string %}
  <form id="timezone-form" action="{{ url('set_timezone') }}" method="post">
    {{ csrf_input }}
    <input type="hidden" name="redirect_to" value="{{ return_url }}">
    <label for="timezone-selector">Select timezone</label>
    <select id="timezone-selector" name="timezone">
     {% for tz in tz_list %}
      <option value="{{ tz }}"{% if tz == current_tz %} selected{% endif %}>{{ tz }}</option>
     {% endfor %}
    </select>
    <button id="timezone-local-btn" class="hidden" type="button"><span>Local</span></button>
    <button id="timezone-update-btn" type="submit"><span>Refresh</span></button>
  </form>
{% endmacro %}

{# World history block #}

{% macro world_history_head(world_states) %}
  {# this script contains jinja injections #}
  <script type="module">
    import initWhJs from '{{ static("worldhistory.mjs") }}';
    $(document).ready(function() {
      const wstates = {{ world_states|safe }};
      initWhJs(wstates, "{{ url('snapshot_details', kwargs={'snap_id': 12345}) }}");
    });
  </script>
{% endmacro %}

{% macro bar_line_data(summary, attr_name, day) -%}
  day="{{ day }}" all-snapshots="{{ summary.snapshots|map(attribute='snapshot.id')|join(',') }}"
{%- endmacro %}

{% macro bar_line(summary, attr_name, day, is_today) %}
  {% if summary is none -%}
    <li class="history-bar-line{% if is_today %} today{% endif %} barcol-{{ attr_name }}-unknown" {{ bar_line_data(summary, attr_name, day) }}></li>
  {%- elif summary[attr_name]|length == 1 -%}
    <li class="history-bar-line{% if is_today %} today{% endif %} barcol-{{ attr_name }}-{{ (summary[attr_name]|first).value|string|lower }}" {{ bar_line_data(summary, attr_name, day) }}></li>
  {%- else -%}
    <li class="history-bar-line{% if is_today %} today{% endif %} split" {{ bar_line_data(summary, attr_name, day) }}>
     {% for val in summary[attr_name] %}
      <div class="barcol-{{ attr_name }}-{{ val.value|string|lower }}"></div>
     {% endfor %}
    </li>
  {%- endif %}
{% endmacro %}

{% macro history_bar(day_sums, attr_name, label, today) %}
  <span class="history-bar-label">{{ label }}</span>
  <ol class="history-bar {{ attr_name }}">
   {% for day, summary in day_sums %}
    {{ bar_line(summary, attr_name, day, day == today) }}
   {% endfor %}
  </ol>
{% endmacro %}

{% macro world_history_section(day_sums, world_id, today) %}
<div class="history-bars-wrapper
    {%- if day_sums|length < 9 %} week
    {%- elif day_sums|length < 16 %} twoweek
    {%- elif day_sums|length < 32 %} month
    {%- else %} multmonth
    {%- endif -%}
" world-id="{{ world_id }}">
  {{ history_bar(day_sums, 'status', 'Status', today) }}
  {{ history_bar(day_sums, 'classification', 'Classification', today) }}
  {{ history_bar(day_sums, 'charcreate', 'Character creation', today) }}
  <div class="date-range">
    <p>Today</p>
    <div class="spacer"></div>
    <p>{{ day_sums|length - 1 }} days ago</p>
  </div>
</div>
{% endmacro %}
